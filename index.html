<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#050607">
  <title>Тренировки — программы + журнал</title>
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALQAAAC0CAYAAAA9zQYyAAAISklEQVR4nO3dS4gsVx3H8f//VHVVV/Wde+MiRnGRiBhFDGrEB9FFNqKJQclCXahIXLhyp+BjYVy4UIJuXAR140JRFC8hmqAQM2QTFwaD4SZCFgFFDAlyr2a6633O38VUxyHmmu6ZrpmuzvcDDTP9Oqe7fnXOqUfXEQEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwVWbmzCzaxO3uu+92Z/15sB4z000t//6mZ/VBnJltPIBn+qGwsmWQh3jv/f39+LgZiI/zIjNzqhpERA7q+u3nkiQviuI4b9WbWJ5PtCiKv6vqP15aBraMmaqqiYjf37f41lvl5pMt/0N5nouIPK6q7WExL5YznGWr/O+iuKXpul9VVe2Dmflwslsws6ZtL9dt++3nnpu/7mhZ2B7LltPMXF3Xn66a5nHbwPL3wczMrKqaJ+q6/uz+/n58tLxVrfVkM4tU1R8cLL44m+XfVxUpykrM7EQtqaqKmUkcxy5NJtK27bON2W3n0vTPtNTbow+XE5FJVTU/n06Tj/tgUlXVZpaPmUyzzEVOpayqB7Pp9BMiUotIWLWlXjnQyzCXZfvh6TT+bVFW3g77hGMNW65SholIO8uzpKzqZ7Np+TaRa15YPjx494OXdaSVjFS1WyyKH+R59oX5omhUNVbVjfWkZhZUtc2zaTovyh/vzfK7ltlb5fXrBNqJiCzK6tFpmry3rhsvxxyDr1BWO8uzyaIsv3ouz7+zbKX7jRCjxT4dfZAjVe2W91VV9WYRvWQiznsfqerGN+DNzJxz3jknjYV3nJ9On1q1p15pzerXkLCo649kafq+qqqDDBTmXtS0rYnJlw4O7DoRic0sVVXfB5ux9cCWG2Sq2vV7tDIzm7Q+fD1Nk8R7L0OEWUREVTWEIGkyiSOzr/V3r7TMVw2lioio2Q3OqYnIoF2/qrqu8xJF0bVByicWpTZx5Mx7/+hisbhXVR9ZpxvCepat4dNPP33++uvf+I2yau5wTmed96Kiry/LSjY51LyK5cpyw7Jaq7xorUqZSCNrbkiehPfekiR5rXNOQgjinPvUNMs+dnBQ3qGqD7PBuHn9MMMuX758Ic9nDyZJfEvnD7/iOI6lruthW7P/rVCzztPX7bpP9YCHqmrTNFZVVWiaxhZF2YZgWZJGv5nX85ulH26dZp1eBfTJJ5+cJGn2QJomt8wXRVPXdWiaJmxsb8aa9VnnyUN3GyfWj9OWH2rSdV07y7OsLbu7VPVPBHpzlj1eURTvSafTDxRl1TnnkuXjAw2ZN2qMYXAiYmJ6c/8/u/I2x4mImOq7nEo43Is6LmMMtMhhw12fdSV2WCMjzcYoKy3CYfGBbf/Y4iq2fgz9//ShdmPsGreUMzNXVBWBPn0W+l127LbbnEZEpKzr0Q7nxhhoV9WNqOq750X5Bwmm4jjHY0NURMx3/rrqcPfvIOc7D2l0gV4eFo2i6HyaTN5/1vXZRT6Y1HU92KHtIY0u0Etd11nXdQw3hqGbPIPuNI020H3rMbouEcMa5VoIXA2Bxk4h0NgpBBo7hUBjpxBo7BQCjZ1CoLFTCDR2CoHGTiHQ2CkEGjuFQGOnjPlsO3GO9XEIZiYhjPPM3NEF2sx8lk2jsqr/2Fn4nLats8lknN/+lklVo9rMuyCfzKbpN8uy8qo6qlN0RxdoERGnKmI2Pz/N/nLWddlF87L8mzv8scrofto2ykAf0mj5q2/hh7KbEotIV1RVetYVOa4RB/rwV99mJlywcTP6i42HRVmO9vsc8VaVTs66BjtstN/tGANtIhJE5fn+/9H9MnmLmYiIOve892F042eRkQW6n4PFRMSZ2M/6uwn05gQz06YsH6qbZp6maWxm3Su/bHtsfaDNzJuZDyH4KIp0lmeToqjuOZdlF/ur+I/qC99m/aRMeuHChX8FlTtD8GWeZ/FyGfS3rW6519oo1P7KOgPV5WXN8uzF/aDe+ytFUfxoNpt9hav3D2M5h81elv3+ysHBHXvO/TDLsje5vh9s2k7atj3Na0WvVdBaLbSJtOsWcBz9dHFiZn5elp9ZLBa3icjtURS9lTAPbxnq1+ztPXzx4sW3+K69VUQ+ulgsbmua9rFpmlo4nUOJJiJrzaOzagvtzUwPRH5dlNVzcRxd670PIoNdXcdn0zRaFMUv9vLZT48+QJhPxzLU/cRMjyzvr6pKVeXB/v4hh6wWzFScu3edF61UoX5sFZ1X/aeJfi9NEmeizRDjKTPzURRJ13mNo+hbZhZdunQpWU5qT5hPTx9qNbNof99iM0vSNP1dWdaPzfIsDiGsNaHPqsysmeVZXJbVEw+k6X1HVqxXrvMahSynxU3LqvllNk1uL6taQggb3SibTqdx5FRemM+/fGFv77tM37Y9+iOzNm+am1LVhyaTybWLotzgJY1NRNTN8sw1bXe5bcKHZrPkcemv0bmZMo4W10+Re+mSJXXb3tO07RXbsKZpnzoois/05W39XphXm+UyOTg4uKnz/r66bja7/NvWus7ff2U+f+fR8la19gae9TOM9n+/oW3bz6vqNXXTiagda4NRTUOSxBpUn/rrM8/85MYbb6yNlnlr2ZHtmKZpPqhRdGddVSebJsvMsjyXumzvz/PkkZeWMyjrx1UDvv+oTll8NbLD6ZIH6UFP8t4n2gVn/z3bbZP8sgfA9usbn03uyjV6ZgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAODl/Qf34a/DZ1K1tQAAAABJRU5ErkJggg==">
  <link rel="apple-touch-icon" href="data:image/png;base64,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">
<style>
    :root{
      --bg:#0b0c0e;
      --card:#111317;
      --card2:#0f1114;
      --line: rgba(255,255,255,.10);
      --line2: rgba(255,255,255,.16);
      --text:#f4f6f8;
      --muted: rgba(244,246,248,.72);
      --muted2: rgba(244,246,248,.56);

      --r1: 16px;
      --r2: 20px;

      --shadow: 0 10px 24px rgba(0,0,0,.45);
      --shadow2: 0 6px 16px rgba(0,0,0,.35);

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", system-ui, Segoe UI, Roboto, Ubuntu, Arial;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    html{-webkit-text-size-adjust:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: var(--bg);
      min-height: 100vh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      overflow-x:hidden;
      -webkit-overflow-scrolling: touch;
    }
    @supports (min-height: 100dvh){
      body{ min-height: 100dvh; }
    }
    *{ -webkit-tap-highlight-color: rgba(255,255,255,.08); }

    .wrap{
      max-width: 1100px;
      margin:0 auto;
      padding: 14px;
    }

    /* Top */
    .top{ display:flex; align-items:center; justify-content:center; padding: 10px 0 12px; }
    .brand{ width:100%; display:flex; align-items:center; justify-content:center; gap:10px; }
    .logo{ display:none; }
    h1{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
      font-weight: 900;
    }

    /* Layout */
    .grid{ display:flex; flex-direction:column; gap:12px; align-items:stretch; }

    /* Card */
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border: 1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card:before{ content:none; }

    .sticky{ position: static; }

    .hdr{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      backdrop-filter: blur(6px);
    }
    .hdr h2{
      margin:0;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .6px;
      text-transform: uppercase;
      color: var(--muted2);
    }
    .cardPad{ padding: 12px; }

    .small{ font-size: 12px; color: var(--muted2); }
    .note{ font-size: 12px; color: var(--muted); line-height: 1.35; }

    /* Form */
    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin: 10px 0 6px;
      font-weight: 800;
      letter-spacing: .2px;
    }
    input[type="date"], input[type="text"], select, textarea{
      width:100%;
      height: 44px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      outline:none;
      font-size: 16px;
    }
    textarea{
      height:auto;
      min-height: 110px;
      resize: vertical;
      padding: 12px;
    }
    input:focus, select:focus, textarea:focus{
      border-color: var(--line2);
    }
    input[type="date"]{ -webkit-appearance:none; appearance:none; }
    select{
      -webkit-appearance:none; appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.75) 50%),
        linear-gradient(135deg, rgba(255,255,255,.75) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 2px),
        calc(100% - 13px) calc(50% - 2px);
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
      padding-right: 34px;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width: 160px; }

    /* Buttons */
    .btnRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }
    button{
      cursor:pointer;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      border-radius: 14px;
      padding: 12px 14px;
      min-height: 44px;
      font-weight: 900;
      letter-spacing: .2px;
      user-select:none;
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.22);
    }
    button.danger{ background: rgba(255,255,255,.02); }
    button.small{
      min-height: 40px;
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 900;
    }

    /* Progress + stats */
    .progressWrap{ margin-top: 10px; }
    .progressLine{
      height: 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .progressBar{
      height:100%;
      width:0%;
      background: rgba(255,255,255,.78);
      transition: width .2s ease;
    }
    .progressMeta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top: 8px;
      font-size: 12px;
      color: var(--muted2);
      font-family: var(--mono);
    }

    .stats{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px; }
    .stat{
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .stat:before{ content:none; }
    .statPad{ padding: 10px 12px; }
    .stat .k{
      font-size: 11px;
      color: var(--muted2);
      font-weight: 900;
      letter-spacing:.5px;
      text-transform: uppercase;
    }
    .stat .v{
      margin-top: 6px;
      font-family: var(--mono);
      font-size: 16px;
      color: var(--text);
    }

    /* Workout title area */
    .workTitle{ display:flex; justify-content:space-between; align-items:baseline; gap:10px; flex-wrap:wrap; }
    .workTitle h3{ margin:0; font-size: 16px; font-weight: 950; letter-spacing:.2px; }

    /* Exercise blocks */
    .ex{
      margin-top: 12px;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .ex:before{ content:none; }
    .exHead{
      padding: 12px 12px 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:flex-start;
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .exName{
      margin:0;
      font-size: 13px;
      line-height: 1.25;
      font-weight: 900;
      letter-spacing:.15px;
    }
    .exMeta{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .tag{
      font-family: var(--mono);
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted);
    }
    .tag.muted{ color: var(--muted2); }

    .exDone{
      font-family: var(--mono);
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--muted2);
      white-space: nowrap;
    }

    /* Sets */
    .setGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 12px;
    }
    .setRow{
      display:flex;
      align-items:center;
      gap:10px;
      min-height: 52px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding: 10px 12px;
      user-select:none;
    }
    .setRow input[type="checkbox"]{ width:18px; height:18px; accent-color: #ffffff; }
    .setRow .s{ font-size: 12px; color: var(--muted2); min-width: 70px; font-weight: 900; }

    .mini{
      width: 100%;
      height: 40px;
      padding: 8px 10px !important;
      border-radius: 14px !important;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--text);
      font-family: var(--mono);
      font-size: 16px;
      outline:none;
    }
    .mini::placeholder{ color: rgba(244,246,248,.35); }
    .mini:focus{ border-color: var(--line2); }

    /* Details / sections */
    details{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    details:before{ content:none; }
    summary{
      cursor:pointer;
      padding: 12px 12px;
      font-weight: 950;
      letter-spacing: .2px;
      color: var(--text);
      list-style:none;
    }
    summary::-webkit-details-marker{ display:none; }
    .detailsPad{ padding: 0 12px 12px; }

    .historyItem{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      border-radius: 16px;
      padding: 10px 10px;
      margin-top: 10px;
    }
    .historyTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .historyTop .t{ font-weight: 950; letter-spacing:.15px; }
    .historyTop .s{ color: var(--muted2); font-size: 12px; font-family: var(--mono); }
    .historyBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px; }

    /* Timer */
    .timerBox{
      margin-top: 12px;
      border: 1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.02);
      overflow:hidden;
    }
    .timerBox:before{ content:none; }
    .timerPad{ padding: 10px 12px; }
    .timerTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:baseline; }
    .timerTop .v{ font-family: var(--mono); font-size: 18px; }
    .timerTop .k{ font-size: 11px; color: var(--muted2); font-weight: 950; letter-spacing:.5px; text-transform: uppercase; }
    .timerBtns{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 10px; }
    .timerBtns button.small{ flex:1; min-width: 0; }

    /* Mobile */
    @media (max-width: 520px){
      .wrap{ padding: 12px; }
      .hdr{ padding: 12px; }
      .cardPad{ padding: 12px; }
      .btnRow button{ width: 100%; }
      .timerBtns button.small{ flex:1; }
      .stats{ grid-template-columns: 1fr; }
      .row > *{ min-width: 140px; }
      h1{ font-size: 17px; }
    }

    /* Program picker (touch devices) */
    .pickBtn{
      width:100%;
      min-height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 12px 14px;
      text-align:left;
      font-weight: 900;
      letter-spacing:.2px;
      display:none;
    }
    .pickBtn:active{ transform: translateY(1px); }
    .nativeSelect{ width:100%; display:block; }

    @media (hover: none) and (pointer: coarse){
      .nativeSelect{ display:none; }
      .pickBtn{ display:block; }
    }
    @media (hover: hover){
      .nativeSelect, .nativeSelect option, .nativeSelect optgroup{ color:#000; background:#fff; }
    }

    /* Bottom sheet */
    .sheet{ position:fixed; inset:0; display:none; z-index: 90; }
    .sheet[aria-hidden="false"]{ display:block; }
    .sheetBackdrop{ position:absolute; inset:0; background: rgba(0,0,0,.55); }
    .sheetCard{
      position:absolute; left:0; right:0; bottom:0;
      background: rgba(15,17,20,.98);
      border-top-left-radius: 22px;
      border-top-right-radius: 22px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 14px 30px rgba(0,0,0,.55);
      padding-bottom: calc(12px + env(safe-area-inset-bottom));
      max-height: 86vh;
      overflow:hidden;
    }
    .sheetTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding:12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
    }
    .sheetTitle{ font-size:13px; font-weight:950; letter-spacing:.2px; color: var(--text); }
    .sheetClose{
      width:40px; height:40px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      font-weight:950;
    }
    .sheetBody{ padding:12px; overflow:auto; max-height: 86vh; }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; }
    .chip{
      height:36px;
      padding: 0 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      color: var(--text);
      font-weight: 900;
      font-size: 12px;
    }
    .chip:active{ transform: translateY(1px); }
    .sheetSearch{
      width:100%;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding: 10px 12px;
      font-size: 16px;
      outline:none;
      margin: 10px 0 10px;
    }
    .sheetList{ display:flex; flex-direction:column; gap:10px; }
    .sheetGroup{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(255,255,255,.02);
    }
    .sheetGroupTitle{
      padding: 10px 12px;
      font-size: 11px;
      font-weight: 950;
      letter-spacing:.6px;
      text-transform: uppercase;
      color: rgba(244,246,248,.56);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .sheetItem{
      padding: 12px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .sheetItem:first-of-type{ border-top:none; }
    .sheetItem:active{ background: rgba(255,255,255,.04); }
    .sheetName{ font-weight: 900; font-size: 14px; }
    .sheetCode{ font-family: var(--mono); font-size: 12px; color: rgba(244,246,248,.56); }

    /* Layout stability fixes (iPhone) */
    *{ max-width: 100%; }
    img, svg, video, canvas{ max-width:100%; height:auto; }
    .wrap{ width: 100%; }

    /* Prevent horizontal overflow */
    body{ overflow-x: hidden; }
    .card, .sheetCard{ overflow: hidden; }

    /* Flex/grid children must be allowed to shrink */
    .row > *, .exHead > *, .sheetItem > *, .historyTop > *{ min-width: 0; }
    .sheetName{ flex: 1; min-width: 0; }
    .sheetName, .exName{ overflow:hidden; text-overflow: ellipsis; }
    .sheetCode{ white-space: nowrap; }
    .tag, .exDone{ max-width: 100%; overflow:hidden; text-overflow: ellipsis; }

    /* Set rows: avoid pushing layout on small screens */
    .setRow{ flex-wrap: wrap; }
    .setRow .s{ flex: 1 1 120px; }
    .setRow .mini{ flex: 1 1 120px; }

    /* Chips wrap nicely */
    .chips{ align-items: center; }
    .chip{ flex: 0 0 auto; }

    @media (max-width: 520px){
      .row > *{ min-width: 0; flex: 1 1 100%; }
      .setRow{ gap: 8px; }
      .setRow .s{ flex: 1 1 100%; }
      .setRow .mini{ flex: 1 1 calc(50% - 4px); }
      .setRow input[type="checkbox"]{ margin-right: 2px; }
    }

    /* Hard anti-shift fixes for phones */
    @media (hover: none) and (pointer: coarse){
      .grid{ grid-template-columns: 1fr !important; }
      .wrap{ max-width: 100% !important; }
      .sticky{ position: static !important; top:auto !important; }
    }

    /* Any element that might force width */
    .grid, .card, .cardPad, .hdr, .sheetCard, .sheetBody, .setGrid, .ex, details, summary{
      min-width: 0;
    }

    /* Prevent long monospace strings from widening */
    .sheetCode, .progressMeta, .stat .v{
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    /* Nuclear overflow fix (iOS) */
    html, body{ width:100%; max-width:100%; }
    html{ overflow-x: clip; }
    @supports not (overflow-x: clip){
      html{ overflow-x: hidden; }
    }
    body{ overflow-x: hidden; }

    /* Auto-shrink for any element detected wider than viewport */
    .shrink{
      max-width: 100% !important;
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      word-break: break-word !important;
      overflow-wrap: anywhere !important;
    }
    .shrink *{
      max-width: 100% !important;
    }

    /* Static screen layout: keep viewport stable, scroll inside app container */
    html, body{
      height: 100%;
    }
    body{
      position: fixed;
      inset: 0;
      overflow: hidden !important;
    }
    .appViewport{
      height: 100%;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: none;
      scrollbar-gutter: stable;
    }

    /* Make cards and sheet not reflow-jump */
    .sheetCard{ max-height: 86%; }
    @supports (height: 100dvh){
      body{ height: 100dvh; }
      .appViewport{ height: 100dvh; }
    }

    /* Disable all animations/transitions to avoid "jumping" */
    *{
      animation: none !important;
      transition: none !important;
      scroll-behavior: auto !important;
    }

    /* Lock both panels: each card becomes its own scroll area */
    .card{
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .hdr{ flex: 0 0 auto; }
    .cardPad{ flex: 1 1 auto; min-height: 0; overflow:auto; -webkit-overflow-scrolling: touch; }

    

    /* Phone redesign: sidebar panel on top */
    @media (hover: none) and (pointer: coarse){
      .wrap{ height: 100%; }
      .grid{
        height: 100%;
        display:flex !important;
        flex-direction:column !important;
        gap: 12px;
        min-height: 0;
      }
      .grid > aside.card{
        flex: 0 0 auto;
      }
      .grid > main.card{
        flex: 1 1 auto;
        min-height: 0;
      }
      /* Sidebar content scroll only if it grows too much */
      .grid > aside.card .cardPad{
        max-height: 46vh;
        overflow:auto;
        -webkit-overflow-scrolling: touch;
      }
      /* Workout panel scrolls inside */
      .grid > main.card .cardPad{
        overflow:auto;
        -webkit-overflow-scrolling: touch;
      }
      .sticky{ position: static !important; }
    }

    @media (prefers-reduced-motion: reduce){
      *{ transition:none !important; scroll-behavior:auto !important; }
    }
</style>
</head>
<body>
  <div class="appViewport"><div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M7 20V10.5C7 8.01472 9.01472 6 11.5 6H13C15.7614 6 18 8.23858 18 11V20" stroke="rgba(255,255,255,.88)" stroke-width="1.8" stroke-linecap="round"/>
            <path d="M6 14h13" stroke="rgba(255,255,255,.70)" stroke-width="1.8" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Тренировки</h1>
</div>
      </div>
</div>

    <div class="grid">
      <aside class="card sticky">
        <div class="hdr">
          <h2>Панель</h2>
</div>
        <div class="cardPad">
          <div class="row">
            <div>
              <label for="date">Дата</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="template">Шаблон недели</label>
              <select id="template">
                <option value="4_hyp">4×/нед (масса PPL+G)</option>
                <option value="3_fb">3×/нед (full body)</option>
                <option value="5_str">5×/нед (силовой)</option>
                <option value="6_ppl">6×/нед (PPL×2)</option>
              </select>
            </div>
          </div>

          <label for="program">Программа</label>
          <button id="programBtn" class="pickBtn" type="button" aria-haspopup="dialog" aria-controls="programSheet">Выбрать…</button>
          <select id="program" class="nativeSelect"></select>
<div class="btnRow">
            <button class="primary" id="btnToday">Сегодня / Следующая</button>
            <button id="btnSave">Сохранить в журнал</button>
          </div>

          <div class="btnRow" style="margin-top:10px">
            <button class="danger" id="btnReset">Сбросить ввод (дата+прога)</button>
            <button id="btnCopy">Скопировать заметку</button>
          </div>

          <div class="progressWrap">
            <div class="progressLine"><div class="progressBar" id="progressBar"></div></div>
            <div class="progressMeta">
              <span id="progressText">0%</span>
              <span id="progressSets">0/0 подходов</span>
            </div>
          </div>

          <div class="stats">
            <div class="stat"><div class="statPad">
              <div class="k">Тоннаж</div>
              <div class="v" id="tonnage">0 кг</div>
            </div></div>
            <div class="stat"><div class="statPad">
              <div class="k">Упражнений</div>
              <div class="v" id="exCount">0</div>
            </div></div>
          </div>

          <div class="timerBox">
            <div class="timerPad">
              <div class="timerTop">
                <div>
                  <div class="k">Таймер отдыха</div>
                  <div class="v" id="timerText">00:00</div>
                </div>
                <div class="small" id="timerState">—</div>
              </div>
              <div class="timerBtns">
                <button class="small" data-t="60">60с</button>
                <button class="small" data-t="90">90с</button>
                <button class="small" data-t="120">120с</button>
                <button class="small" data-t="180">180с</button>
                <button class="small" id="timerStop">Стоп</button>
              </div>
            </div>
          </div>

          <details open>
            <summary>Журнал (последние 12)</summary>
            <div class="detailsPad" id="history"></div>
          </details>

          <details>
            <summary>Поиск упражнения</summary>
            <div class="detailsPad">
              <label for="search">Номер или название</label>
              <input id="search" type="text" placeholder="например: 05-03 или 'жим' или 'подтяг'" />
              
              <div id="searchResults"></div>
            </div>
          </details>

          <details>
            <summary>Импорт/экспорт программ</summary>
            <div class="detailsPad">
              <div class="btnRow">
                <button class="small" id="btnExport">Экспорт</button>
                <button class="small" id="btnImport">Импорт</button>
                <button class="small" id="btnResetPrograms">Сбросить программы</button>
              </div>
              <label for="jsonArea">JSON</label>
              <textarea id="jsonArea" placeholder="Нажми «Экспорт» или вставь JSON и нажми «Импорт»"></textarea>
            </div>
          </details>

          </div>
      </aside>

      <main class="card">
        <div class="hdr">
          <h2>Тренировка</h2>
          
        </div>
        <div class="cardPad">
          <div class="workTitle">
            <h3 id="workTitle">—</h3>
</div>
          <div class="note" id="workNote" style="margin-top:6px"></div>
          <div id="workout"></div>
        </div>
      </main>
    </div>
  </div>


  <div id="programSheet" class="sheet" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="sheetBackdrop" data-close="1"></div>
    <div class="sheetCard" role="document">
      <div class="sheetTop">
        <div class="sheetTitle">Выбор тренировки</div>
        <button class="sheetClose" type="button" data-close="1" aria-label="Закрыть">✕</button>
      </div>
      <div class="sheetBody">
        <div class="chips" aria-label="быстрый выбор">
          <button type="button" class="chip" data-filter="Ноги">Ноги</button>
          <button type="button" class="chip" data-filter="Грудь">Грудь</button>
          <button type="button" class="chip" data-filter="Спина">Спина</button>
          <button type="button" class="chip" data-filter="Плечи">Плечи</button>
          <button type="button" class="chip" data-filter="Руки">Руки</button>
          <button type="button" class="chip" data-filter="Пресс">Пресс</button>
          <button type="button" class="chip" data-filter="Full">Full</button>
          <button type="button" class="chip" data-filter="">Все</button>
        </div>
        <input id="programSearch" class="sheetSearch" type="text" inputmode="search" placeholder="Поиск…" />
        <div id="programList" class="sheetList"></div>
      </div>
    </div>
  </div>

<script>  // Safe storage wrapper (iOS private mode / file:// can break localStorage)
  // Fallback order: localStorage -> cookies -> memory
  const storage = (() => {
    const mem = {};
    const prefix = "tw::";

    function cookieGet(k){
      try{
        const name = encodeURIComponent(prefix+k) + "=";
        const parts = document.cookie.split("; ");
        for(const p of parts){
          if(p.startsWith(name)) return decodeURIComponent(p.slice(name.length));
        }
      }catch(e){}
      return null;
    }
    function cookieSet(k,v){
      try{
        const val = encodeURIComponent(String(v));
        document.cookie = `${encodeURIComponent(prefix+k)}=${val}; Max-Age=31536000; Path=/; SameSite=Lax`;
        return true;
      }catch(e){}
      return false;
    }
    function cookieDel(k){
      try{
        document.cookie = `${encodeURIComponent(prefix+k)}=; Max-Age=0; Path=/; SameSite=Lax`;
        return true;
      }catch(e){}
      return false;
    }

    function lsWorks(){
      try{
        const t="__t";
        storage.set(t,"1");
        storage.del(t);
        return true;
      }catch(e){ return false; }
    }
    const useLS = lsWorks();

    function get(k){
      if(useLS){
        try{ const v = storage.get(prefix+k); return v===null ? null : v; }catch(e){}
      }
      const c = cookieGet(k);
      if(c !== null) return c;
      return (k in mem) ? mem[k] : null;
    }
    function set(k,v){
      if(useLS){
        try{ storage.set(prefix+k, String(v)); return; }catch(e){}
      }
      if(cookieSet(k,v)) return;
      mem[k]=String(v);
    }
    function del(k){
      if(useLS){
        try{ storage.del(prefix+k); }catch(e){}
      }
      cookieDel(k);
      delete mem[k];
    }
    return { get, set, del };
  })();


  const EX = {
    "01-01":"Попеременные сгибания рук с гантелями",
    "01-02":"Концентрированное сгибание одной руки с гантелью",
    "01-03":"Сгибание рук с гантелями хватом «молоток»",
    "01-04":"Сгибание одной руки с рукояткой нижнего блока",
    "01-05":"Сгибание рук с рукоятками верхних блоков",
    "01-06":"Сгибание рук с грифом штанги",
    "01-07":"Сгибание рук на тренажёре «Larry-Scott»",
    "01-08":"Сгибание рук на скамье «Larry-Scott»",
    "01-09":"Сгибание рук со штангой хватом сверху",
    "01-10":"Разгибание запястий со штангой хватом сверху",
    "01-11":"Сгибание запястий со штангой хватом снизу",
    "01-12":"Разгибание рук с рукояткой верхнего блока хватом сверху",
    "01-13":"Разгибание рук с рукояткой верхнего блока хватом снизу",
    "01-14":"Разгибание одной руки с верхним блоком хватом снизу",
    "01-15":"Разгибание рук со штангой лёжа",
    "01-16":"Разгибание рук с гантелями лёжа",
    "01-17":"Разгибание одной руки с гантелью из-за головы",
    "01-18":"Разгибание рук с одной гантелью из-за головы",
    "01-19":"Разгибание рук с изогнутым грифом штанги из-за головы",
    "01-20":"Разгибание одной руки назад с гантелью в наклоне",
    "01-21":"Отжимания трицепсами спиной к скамье",
    "02-01":"Жим штанги из-за головы сидя",
    "02-02":"Жим штанги с груди сидя",
    "02-03":"Жим гантелей сидя",
    "02-04":"Попеременный жим гантелей с поворотами запястий",
    "02-05":"Подъёмы гантелей в стороны в наклоне вперёд",
    "02-06":"Подъёмы гантелей в стороны",
    "02-07":"Подъёмы гантелей вперёд попеременно",
    "02-08":"Подъём гантели в сторону одной рукой, лёжа на боку",
    "02-09":"Подъём одной руки в сторону с нижнего блока",
    "02-10":"Подъём одной руки вперёд с нижнего блока стоя",
    "02-11":"Перекрёстные махи руками назад с верхних блоков",
    "02-12":"Перекрёстные махи руками назад с нижних блоков в наклоне",
    "02-13":"Подъёмы рук вперёд с одной гантелью",
    "02-14":"Подъёмы штанги вперёд",
    "02-15":"Плечевая передняя протяжка",
    "02-16":"Подъёмы рук в стороны на тренажёре",
    "02-17":"Махи руками назад с рукоятками тренажёра",
    "03-01":"Жим штанги, лёжа на наклонной скамье",
    "03-02":"Жим штанги, лёжа на горизонтальной скамье",
    "03-03":"Жим штанги узким хватом, лёжа на скамье",
    "03-04":"Жим штанги, лёжа на скамье с уклоном",
    "03-05":"Отжимания от пола",
    "03-06":"Отжимания на брусьях",
    "03-07":"Жим гантелей лёжа",
    "03-08":"Разведение гантелей лёжа",
    "03-09":"Жим гантелей, лёжа на наклонной скамье",
    "03-10":"Разведение гантелей, лёжа на наклонной скамье",
    "03-11":"Сведение рук на тренажёре",
    "03-12":"Сведение верхних блоков «cross-over»",
    "03-13":"Тяга гантели из-за головы лёжа «pull-over»",
    "03-14":"Тяга штанги лёжа «pull-over»",
    "04-01":"Подтягивания на перекладине хватом снизу",
    "04-02":"Подтягивания на специальной перекладине",
    "04-03":"Тяги верхнего блока перед собой",
    "04-04":"Тяги верхнего блока за шею",
    "04-05":"Тяги верхнего блока узким хватом",
    "04-06":"Тяги верхнего блока прямыми руками",
    "04-07":"Тяги нижнего блока (гребля)",
    "04-08":"Тяги гантели одной рукой",
    "04-09":"Тяги штанги, стоя в наклоне",
    "04-10":"Тяги Т-образного грифа (гребля)",
    "04-11":"Тяги Т-образного грифа (гребля) с упором",
    "04-12":"«Мёртвые» тяги со штангой, ноги прямые",
    "04-13":"«Мёртвые» тяги в стиле сумо",
    "04-14":"Становые тяги со штангой",
    "04-15":"Поясничные прогибания",
    "04-16":"Разгибания туловища на тренажёре",
    "04-17":"Вертикальные тяги",
    "04-18":"Шраги со штангой",
    "04-19":"Шраги с гантелями",
    "04-20":"Шраги на тренажёре",
    "05-01":"Приседания с гантелями",
    "05-02":"Приседания со штангой на груди",
    "05-03":"Приседания со штангой на плечах",
    "05-04":"Широкие приседания",
    "05-05":"Наклонный жим ногами",
    "05-06":"Приседания на тренажёре «Hack squat»",
    "05-07":"Разгибание ног",
    "05-08":"Сгибание ног лёжа",
    "05-09":"Сгибание одной ноги стоя",
    "05-10":"Сгибание ног сидя",
    "05-11":"Подъёмы торса «с добрым утром»",
    "05-12":"Приведение одной ноги стоя",
    "05-13":"Сведение ног сидя",
    "05-14":"Подъёмы на носки стоя",
    "05-15":"Подъём на носок одной ноги стоя",
    "05-16":"Подъёмы на носки в наклоне «ослик»",
    "05-17":"Разгибание голени сидя",
    "05-18":"Разгибание голени сидя, со штангой на коленях",
    "06-01":"Выпады со штангой на плечах",
    "06-02":"Выпады с гантелями",
    "06-03":"Махи ногой назад с нижнего блока",
    "06-04":"Махи ногой назад с рычагом тренажёра",
    "06-05":"Махи ногой назад на полу",
    "06-06":"«Мостик» лёжа",
    "06-07":"Махи ногой в сторону с нижнего блока",
    "06-08":"Махи ногой в сторону с рычагом тренажёра",
    "06-09":"Махи ногой в сторону, лёжа на боку",
    "06-10":"Разведение ног на тренажёре",
    "07-01":"Сворачивание туловища на полу",
    "07-02":"Подъёмы туловища",
    "07-03":"Подъёмы туловища у гимнастической стенки",
    "07-04":"Сворачивание туловища с голенью на скамье",
    "07-05":"Подъёмы туловища на наклонной скамье",
    "07-06":"Подъёмы туловища на вертикальной скамье",
    "07-07":"Сворачивание туловища с верхним блоком",
    "07-08":"Сворачивание туловища на тренажёре",
    "07-09":"Подъёмы ног на наклонной скамье",
    "07-10":"Подъёмы коленей в упоре",
    "07-11":"Подъёмы коленей в висе",
    "07-12":"Развороты туловища с грифом",
    "07-13":"Боковые наклоны туловища стоя",
    "07-14":"Боковые подъёмы туловища на римском стуле",
    "07-15":"Вращения туловища стоя на тренажёре «твист»"
  };

  const DEFAULT_PROGRAMS = {
    "legs_strength": { group:"База / сила", name:"Ноги — сила (присед)", note:"Тяжёлая база. Держи технику, отдых 2–3 мин на основных.", items:[
      {id:"05-03", sets:5, reps:"3–6"},
      {id:"05-05", sets:4, reps:"6–10"},
      {id:"05-08", sets:4, reps:"8–12"},
      {id:"05-14", sets:5, reps:"8–12"},
    ]},
    "pull_strength": { group:"База / сила", name:"Спина — сила (тяги/подтягивания)", note:"Основной акцент: подтягивания и тяга в наклоне.", items:[
      {id:"04-01", sets:5, reps:"4–8"},
      {id:"04-09", sets:5, reps:"4–8"},
      {id:"04-07", sets:4, reps:"8–12"},
      {id:"04-18", sets:4, reps:"10–15"},
    ]},
    "push_strength": { group:"База / сила", name:"Грудь — сила (жим)", note:"Тяжёлый жим + плечи. Отдых 2–3 мин на жиме.", items:[
      {id:"03-02", sets:5, reps:"3–6"},
      {id:"03-07", sets:4, reps:"6–10"},
      {id:"02-02", sets:4, reps:"4–8"},
      {id:"01-15", sets:3, reps:"6–10"},
    ]},

    "legs_hypertrophy": { group:"Масса / гипертрофия", name:"Ноги — масса (квадры+бицепс бедра)", note:"Средние веса, много качественных повторов.", items:[
      {id:"05-05", sets:4, reps:"8–12"},
      {id:"05-07", sets:4, reps:"12–15"},
      {id:"05-08", sets:4, reps:"10–15"},
      {id:"05-04", sets:3, reps:"8–12"},
      {id:"05-14", sets:4, reps:"12–20"},
    ]},
    "push_hypertrophy": { group:"Масса / гипертрофия", name:"Push — масса (грудь+плечи+трицепс)", note:"Жимы → разведения → плечи → трицепс.", items:[
      {id:"03-02", sets:4, reps:"6–10"},
      {id:"03-08", sets:4, reps:"10–15"},
      {id:"02-06", sets:4, reps:"12–20"},
      {id:"02-03", sets:3, reps:"8–12"},
      {id:"01-12", sets:3, reps:"10–15"},
    ]},
    "pull_hypertrophy": { group:"Масса / гипертрофия", name:"Pull — масса (спина+бицепс)", note:"Больше объёма на широчайшие и бицепс.", items:[
      {id:"04-03", sets:4, reps:"8–12"},
      {id:"04-07", sets:4, reps:"8–12"},
      {id:"04-08", sets:3, reps:"10–12"},
      {id:"01-06", sets:4, reps:"8–12"},
      {id:"01-03", sets:3, reps:"10–12"},
    ]},

    "shoulders_focus": { group:"Плечи / руки", name:"Плечи — акцент", note:"Сначала жим, потом махи в стороны/задняя дельта.", items:[
      {id:"02-03", sets:4, reps:"6–10"},
      {id:"02-06", sets:5, reps:"12–20"},
      {id:"02-05", sets:4, reps:"12–20"},
      {id:"02-15", sets:3, reps:"10–15"},
    ]},
    "arms_focus": { group:"Плечи / руки", name:"Руки — бицепс+трицепс", note:"Короткая, но «памповая» тренировка.", items:[
      {id:"01-06", sets:4, reps:"8–12"},
      {id:"01-02", sets:3, reps:"10–12"},
      {id:"01-15", sets:4, reps:"8–12"},
      {id:"01-20", sets:3, reps:"12–15"},
    ]},

    "glutes_abs": { group:"Ягодицы / пресс", name:"Ягодицы + пресс", note:"Средняя нагрузка. Хорошо как 4–6-я тренировка недели.", items:[
      {id:"06-01", sets:4, reps:"8–12/нога"},
      {id:"06-06", sets:5, reps:"10–15"},
      {id:"06-03", sets:4, reps:"12–15/нога"},
      {id:"07-02", sets:4, reps:"12–20"},
      {id:"07-09", sets:4, reps:"10–15"},
    ]},
    "abs_only": { group:"Ягодицы / пресс", name:"Пресс — коротко", note:"Если надо быстро добить кор после тренировки.", items:[
      {id:"07-02", sets:4, reps:"12–25"},
      {id:"07-09", sets:4, reps:"10–20"},
      {id:"07-13", sets:3, reps:"12–20/сторона"},
    ]},

    "fullbody_a": { group:"Full body", name:"Full body A", note:"База по всему телу. Не доводи каждый подход до отказа.", items:[
      {id:"05-03", sets:4, reps:"5–8"},
      {id:"03-02", sets:4, reps:"6–10"},
      {id:"04-01", sets:4, reps:"6–12"},
      {id:"02-06", sets:3, reps:"12–20"},
      {id:"07-02", sets:3, reps:"12–20"},
    ]},
    "fullbody_b": { group:"Full body", name:"Full body B", note:"Вариант B: больше тяги/ног, меньше жима.", items:[
      {id:"05-05", sets:4, reps:"8–12"},
      {id:"04-07", sets:4, reps:"8–12"},
      {id:"03-09", sets:3, reps:"8–12"},
      {id:"01-06", sets:3, reps:"8–12"},
      {id:"07-09", sets:3, reps:"10–15"},
    ]},
  };

  const GROUP_ORDER = ["База / сила", "Масса / гипертрофия", "Плечи / руки", "Ягодицы / пресс", "Full body", "Другое"];

  const TEMPLATES = {
    "4_hyp": { order:["push_hypertrophy","pull_hypertrophy","legs_hypertrophy","glutes_abs"] },
    "3_fb":  { order:["fullbody_a","fullbody_b","fullbody_a"] },
    "5_str": { order:["push_strength","pull_strength","legs_strength","shoulders_focus","arms_focus"] },
    "6_ppl": { order:["push_hypertrophy","pull_hypertrophy","legs_hypertrophy","push_strength","pull_strength","legs_strength"] },
  };

  const K = {
    programs: "programs::v2",
    state: (date, prog) => `state::${date}::${prog}`,
    history: "history::v2",
    cycle: (tpl) => `cycle::${tpl}`,
  };

  const $ = (id)=>document.getElementById(id);
  const elDate = $("date");
  const elTemplate = $("template");
  const elProgram = $("program");

  const elProgressBar = $("progressBar");
  const elProgressText = $("progressText");
  const elProgressSets = $("progressSets");
  const elTonnage = $("tonnage");
  const elExCount = $("exCount");

  const elWorkTitle = $("workTitle");
  const elWorkNote  = $("workNote");
  const elWorkout   = $("workout");

  const elHistory = $("history");
  const elSearch = $("search");
  const elSearchResults = $("searchResults");
  const elJsonArea = $("jsonArea");

  const elTimerText = $("timerText");
  const elTimerState = $("timerState");
  const btnStop = $("timerStop");

  function todayISO(){
    const d = new Date();
    const z = (n)=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`;
  }
  function formatMMSS(sec){
    const m = Math.floor(sec/60);
    const s = sec%60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function loadPrograms(){
    const raw = storage.get(K.programs);
    if(!raw) return structuredClone(DEFAULT_PROGRAMS);
    try{
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return structuredClone(DEFAULT_PROGRAMS);
      return obj;
    }catch{
      return structuredClone(DEFAULT_PROGRAMS);
    }
  }
  function savePrograms(obj){ storage.set(K.programs, JSON.stringify(obj)); }

  function loadState(date, prog){
    const raw = storage.get(K.state(date, prog));
    if(!raw) return null;
    try{ return JSON.parse(raw); }catch{ return null; }
  }
  function saveState(date, prog, state){
    storage.set(K.state(date, prog), JSON.stringify(state));
  }
  function clearState(date, prog){
    storage.del(K.state(date, prog));
  }
  function ensureState(date, prog, PROGRAMS){
    const p = PROGRAMS[prog];
    const state = loadState(date, prog) || { date, prog, ex:{} };

    p.items.forEach(it=>{
      if(!state.ex[it.id]) state.ex[it.id] = { sets: [] };
      const arr = state.ex[it.id].sets;
      while(arr.length < it.sets) arr.push({ done:false, w:"", r:"" });
      if(arr.length > it.sets) arr.length = it.sets;
    });

    saveState(date, prog, state);
    return state;
  }

  function computeStats(PROGRAMS, date, prog){
    const p = PROGRAMS[prog];
    const state = loadState(date, prog) || { ex:{} };
    let total = 0, done = 0, ton = 0;

    p.items.forEach(it=>{
      total += it.sets;
      const sets = state.ex?.[it.id]?.sets || [];
      sets.forEach(s=>{
        if(s?.done) done++;
        const w = Number(String(s?.w ?? "").replace(",", "."));
        const r = Number(String(s?.r ?? "").replace(",", "."));
        if(s?.done && w>0 && r>0) ton += w*r;
      });
    });

    const pct = total ? Math.round((done/total)*100) : 0;
    return { total, done, pct, ton: Math.round(ton) };
  }

  function perExerciseDone(state, it){
    const sets = state.ex?.[it.id]?.sets || [];
    let d = 0;
    sets.forEach(s=>{ if(s?.done) d++; });
    return { d, t: it.sets };
  }

  function readHistory(){
    const raw = storage.get(K.history);
    if(!raw) return [];
    try{
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch{ return []; }
  }
  function writeHistory(arr){
    storage.set(K.history, JSON.stringify(arr.slice(0, 200)));
  }
  function addHistory(entry){
    const arr = readHistory();
    const key = `${entry.date}::${entry.prog}`;
    const filtered = arr.filter(x => `${x.date}::${x.prog}` !== key);
    filtered.unshift(entry);
    writeHistory(filtered);
  }

  function renderHistory(PROGRAMS){
    const arr = readHistory().slice(0,12);
    elHistory.innerHTML = "";
    if(arr.length === 0){
      elHistory.innerHTML = ``;
      return;
    }
    arr.forEach(x=>{
      const p = PROGRAMS[x.prog];
      const item = document.createElement("div");
      item.className = "historyItem";
      item.innerHTML = `
        <div class="historyTop">
          <div class="t">${x.date} · ${p ? p.name : x.prog}</div>
          <div class="s">${x.done}/${x.total} · ${x.pct}% · ${x.ton}кг</div>
        </div>
        <div class="small" style="margin-top:6px">${p ? p.group : ""}</div>
        <div class="historyBtns">
          <button class="small" data-open="${x.date}::${x.prog}">Открыть</button>
          <button class="small" data-del="${x.date}::${x.prog}">Удалить</button>
        </div>
      `;
      elHistory.appendChild(item);
    });

    elHistory.querySelectorAll("[data-open]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const [date, prog] = b.getAttribute("data-open").split("::");
        elDate.value = date;
        elProgram.value = prog;
        renderAll();
      });
    });
    elHistory.querySelectorAll("[data-del]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const [date, prog] = b.getAttribute("data-del").split("::");
        writeHistory(readHistory().filter(x => !(x.date===date && x.prog===prog)));
        renderHistory(PROGRAMS);
      });
    });
  }

  function renderSearch(q){
    const s = (q||"").trim().toLowerCase();
    elSearchResults.innerHTML = "";
    if(!s){
      elSearchResults.innerHTML = ``;
      return;
    }
    const items = Object.entries(EX)
      .map(([id, title])=>({id, title}))
      .filter(x => x.id.toLowerCase().includes(s) || x.title.toLowerCase().includes(s))
      .sort((a,b)=>a.id.localeCompare(b.id))
      .slice(0, 25);

    if(items.length === 0){
      elSearchResults.innerHTML = `<div class="small" style="margin-top:10px">Ничего не найдено.</div>`;
      return;
    }

    items.forEach(x=>{
      const row = document.createElement("div");
      row.className = "historyItem";
      row.style.marginTop = "10px";
      row.innerHTML = `
        <div class="historyTop">
          <div class="t"><span class="kbd">${x.id}</span> ${x.title}</div>
          <div class="s"></div>
        </div>
        <div class="small" style="margin-top:6px">Нажми чтобы скопировать номер</div>
      `;
      row.addEventListener("click", async ()=>{
        try{ await navigator.clipboard.writeText(x.id); }catch{}
        elSearch.value = x.id;
      });
      elSearchResults.appendChild(row);
    });
  }

  function groupOrderKey(g){
    const idx = GROUP_ORDER.indexOf(g);
    return idx === -1 ? 999 : idx;
  }

  function fillProgramSelect(PROGRAMS){
    elProgram.innerHTML = "";
    const groups = Array.from(new Set(Object.values(PROGRAMS).map(p=>p.group || "Другое")))
      .sort((a,b)=> groupOrderKey(a)-groupOrderKey(b) || a.localeCompare(b));

    groups.forEach(g=>{
      const og = document.createElement("optgroup");
      og.label = g;

      Object.keys(PROGRAMS)
        .filter(k => (PROGRAMS[k].group || "Другое") === g)
        .sort((a,b)=> (PROGRAMS[a].name||a).localeCompare(PROGRAMS[b].name||b))
        .forEach(k=>{
          const o = document.createElement("option");
          o.value = k;
          o.textContent = PROGRAMS[k].name || k;
          og.appendChild(o);
        });

      elProgram.appendChild(og);
    });
  }

  function getCycle(tpl){
    const raw = storage.get(K.cycle(tpl));
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }
  function setCycle(tpl, idx){
    storage.set(K.cycle(tpl), String(idx));
  }
  function pickNextProgram(PROGRAMS){
    const tpl = elTemplate.value;
    const order = TEMPLATES[tpl]?.order || [];
    if(order.length === 0) return null;

    let idx = getCycle(tpl);
    idx = ((idx % order.length) + order.length) % order.length;
    let prog = order[idx];

    if(!PROGRAMS[prog]){
      prog = order.find(k => PROGRAMS[k]) || Object.keys(PROGRAMS)[0];
    }
    setCycle(tpl, (idx + 1) % order.length);
    return prog;
  }

  function renderWorkout(PROGRAMS){
    const date = elDate.value;
    const prog = elProgram.value;
    if(!date || !prog || !PROGRAMS[prog]) return;

    const p = PROGRAMS[prog];
    const state = ensureState(date, prog, PROGRAMS);
    elWorkTitle.textContent = p.name || prog;
    elWorkNote.textContent = p.note || "";

    elExCount.textContent = String(p.items.length);
    elWorkout.innerHTML = "";

    p.items.forEach(it=>{
      const exTitle = EX[it.id] || "—";
      const {d,t} = perExerciseDone(state, it);

      const box = document.createElement("div");
      box.className = "ex";

      const head = document.createElement("div");
      head.className = "exHead";
      head.innerHTML = `
        <div>
          <div class="exName">${exTitle}</div>
          <div class="exMeta">
            <span class="tag">${it.id}</span>
            <span class="tag muted">${it.sets}×${it.reps}</span>
          </div>
        </div>
        <div class="exRight">
          <div class="exDone" data-exdone="${it.id}">${d}/${t} подходов</div>
        </div>
      `;

      const grid = document.createElement("div");
      grid.className = "setGrid";

      for(let i=0;i<it.sets;i++){
        const s0 = state.ex[it.id].sets[i] || {done:false,w:"",r:""};

        const row = document.createElement("div");
        row.className = "setRow";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!s0.done;

        const label = document.createElement("div");
        label.className = "s";
        label.textContent = `Подход ${i+1}`;

        const w = document.createElement("input");
        w.type = "text";
        w.className = "mini";
        w.placeholder = "кг";
        w.value = s0.w ?? "";

        const r = document.createElement("input");
        r.type = "text";
        r.className = "mini";
        r.placeholder = "повт";
        r.value = s0.r ?? "";

        const commit = ()=>{
          const st = ensureState(date, prog, PROGRAMS);
          st.ex[it.id].sets[i] = { done: cb.checked, w: (w.value||"").trim(), r: (r.value||"").trim() };
          saveState(date, prog, st);
          renderSidebarStats(PROGRAMS);
          const {d,t} = perExerciseDone(st, it);
          const exDoneEl = box.querySelector(`[data-exdone="${it.id}"]`);
          if(exDoneEl) exDoneEl.textContent = `${d}/${t} подходов`;
        };

        row.addEventListener("click", (e)=>{
          if(e.target && e.target.tagName === "INPUT") return;
          cb.checked = !cb.checked;
          commit();
        });

        cb.addEventListener("change", commit);
        w.addEventListener("input", commit);
        r.addEventListener("input", commit);

        row.appendChild(cb);
        row.appendChild(label);
        row.appendChild(w);
        row.appendChild(r);

        grid.appendChild(row);
      }

      box.appendChild(head);
      box.appendChild(grid);
      elWorkout.appendChild(box);
    });

    renderSidebarStats(PROGRAMS);
  }

  function renderSidebarStats(PROGRAMS){
    const date = elDate.value;
    const prog = elProgram.value;
    if(!date || !prog || !PROGRAMS[prog]) return;

    const stats = computeStats(PROGRAMS, date, prog);
    elProgressBar.style.width = stats.pct + "%";
    elProgressText.textContent = stats.pct + "%";
    elProgressSets.textContent = `${stats.done}/${stats.total} подходов`;
    elTonnage.textContent = `${stats.ton} кг`;
  }

  function makeNote(PROGRAMS, date, prog){
    const p = PROGRAMS[prog];
    const state = loadState(date, prog) || { ex:{} };
    const stats = computeStats(PROGRAMS, date, prog);

    const lines = [];
    lines.push(`Тренировка: ${p.name}`);
    lines.push(`Категория: ${p.group}`);
    lines.push(`Дата: ${date}`);
    lines.push("");

    p.items.forEach(it=>{
      const title = EX[it.id] || "—";
      const sets = state.ex?.[it.id]?.sets || [];
      const done = sets.filter(s=>s?.done).length;
      const parts = sets.map((s, idx)=>{
        const mark = s?.done ? "✓" : "•";
        const ww = (s?.w||"").trim() || "—";
        const rr = (s?.r||"").trim() || "—";
        return `${mark}${idx+1}:${ww}x${rr}`;
      }).join("  ");

      lines.push(`${it.id} — ${title} — ${it.sets}×${it.reps} (сделано: ${done}/${it.sets})`);
      lines.push(`   ${parts}`);
    });

    lines.push("");
    lines.push(`Итого: ${stats.done}/${stats.total} подходов · ${stats.pct}% · тоннаж ${stats.ton} кг`);
    return lines.join("\n");
  }

  let PROGRAMS = loadPrograms();

  function renderAll(){
    if(!elDate.value) elDate.value = todayISO();

    const prev = elProgram.value;
    fillProgramSelect(PROGRAMS);
    if(prev && PROGRAMS[prev]) elProgram.value = prev;

    const chosen = elProgram.value;
    if(!(chosen && PROGRAMS[chosen])){
      const first = Object.keys(PROGRAMS)[0];
      if(first) elProgram.value = first;
    }

    try{
      const p0 = PROGRAMS[elProgram.value];
      if(programBtn && p0) programBtn.textContent = p0.name || elProgram.value;
    }catch(e){}

    renderWorkout(PROGRAMS);
    renderHistory(PROGRAMS);
    renderSearch(elSearch.value);
  }

  // Timer
  let timerInt = null;
  let timerLeft = 0;

  function timerStop(){
    if(timerInt) clearInterval(timerInt);
    timerInt = null;
    timerLeft = 0;
    elTimerText.textContent = "00:00";
    elTimerState.textContent = "—";
  }

  function timerStart(seconds){
    if(timerInt) clearInterval(timerInt);
    timerLeft = seconds;
    elTimerText.textContent = formatMMSS(timerLeft);
    elTimerState.textContent = `${seconds}s`;

    timerInt = setInterval(()=>{
      timerLeft = Math.max(0, timerLeft - 1);
      elTimerText.textContent = formatMMSS(timerLeft);
      if(timerLeft === 0){
        clearInterval(timerInt);
        timerInt = null;
        elTimerState.textContent = "Готово";
        try{ if(navigator.vibrate) navigator.vibrate([120,80,120]); }catch{}
        try{
          const ctx = new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.type = "sine"; o.frequency.value = 880;
          o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.001, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.02);
          g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.22);
          o.start(); o.stop(ctx.currentTime + 0.25);
          setTimeout(()=>ctx.close(), 300);
        }catch{}
      }
    }, 1000);
  }


  function isoDayIndex(iso){
    // Mon=0 ... Sun=6
    const d = new Date(iso + "T12:00:00");
    const jsd = d.getDay(); // Sun=0
    return (jsd + 6) % 7;
  }

  const WEEK = {
    "4_hyp": [ "push_hypertrophy", null, "pull_hypertrophy", null, "legs_hypertrophy", "glutes_abs", null ],
    "3_fb":  [ "fullbody_a", null, "fullbody_b", null, "fullbody_a", null, null ],
    "5_str": [ "push_strength", "pull_strength", null, "legs_strength", "shoulders_focus", "arms_focus", null ],
    "6_ppl": [ "push_hypertrophy", "pull_hypertrophy", "legs_hypertrophy", "push_strength", "pull_strength", "legs_strength", null ],
  };

  function programForDate(iso, tpl){
    const arr = WEEK[tpl];
    if(!arr) return null;
    const idx = isoDayIndex(iso);
    const candidate = arr[idx];
    if(candidate && PROGRAMS[candidate]) return candidate;
    // fallback: first existing in template order
    const order = TEMPLATES[tpl]?.order || [];
    return order.find(k => PROGRAMS[k]) || Object.keys(PROGRAMS)[0] || null;
  }

  function applyTemplateToCurrentDate(){
    const date = elDate.value;
    const tpl = elTemplate.value;
    if(!date || !tpl) return;
    const p = programForDate(date, tpl);
    if(p){
      elProgram.value = p;
      elProgram.dispatchEvent(new Event("change",{bubbles:true}));
    }
  }


  // Events
  $("btnToday").addEventListener("click", ()=>{
    elDate.value = todayISO();
    applyTemplateToCurrentDate();
    renderAll();
  });

  $("btnSave").addEventListener("click", ()=>{
    const date = elDate.value;
    const prog = elProgram.value;
    if(!date || !prog || !PROGRAMS[prog]) return;
    const st = computeStats(PROGRAMS, date, prog);
    addHistory({ date, prog, total: st.total, done: st.done, pct: st.pct, ton: st.ton });
    renderHistory(PROGRAMS);
    /*saved*/
  });

  $("btnReset").addEventListener("click", ()=>{
    const date = elDate.value;
    const prog = elProgram.value;
    if(!date || !prog) return;
    clearState(date, prog);
    renderAll();
  });

  $("btnCopy").addEventListener("click", async ()=>{
    const date = elDate.value;
    const prog = elProgram.value;
    if(!date || !prog || !PROGRAMS[prog]) return;
    const text = makeNote(PROGRAMS, date, prog);
    try{ await navigator.clipboard.writeText(text); }catch{}
    /*copied*/
  });

  elDate.addEventListener("change", ()=>renderAll());
  elProgram.addEventListener("change", ()=>renderAll());
  elSearch.addEventListener("input", ()=>renderSearch(elSearch.value));

  document.querySelectorAll("[data-t]").forEach(b=>{
    b.addEventListener("click", ()=>timerStart(Number(b.getAttribute("data-t"))));
  });
  btnStop.addEventListener("click", timerStop);

  $("btnExport").addEventListener("click", ()=>{
    elJsonArea.value = JSON.stringify(PROGRAMS, null, 2);
  });

  $("btnImport").addEventListener("click", ()=>{
    const raw = elJsonArea.value.trim();
    if(!raw){ /*no_json*/ return; }
    try{
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object"){ alert("JSON должен быть объектом."); return; }
      for(const v of Object.values(obj)){
        if(!v || typeof v !== "object") throw new Error("bad program");
        if(!Array.isArray(v.items)) throw new Error("bad items");
      }
      PROGRAMS = obj;
      savePrograms(PROGRAMS);
      renderAll();
      /*imported*/
    }catch(e){
      /*import_failed*/
    }
  });

  $("btnResetPrograms").addEventListener("click", ()=>{
    PROGRAMS = structuredClone(DEFAULT_PROGRAMS);
    savePrograms(PROGRAMS);
    renderAll();
    /*reset*/
  });

  function getCycle(tpl){
    const raw = storage.get(K.cycle(tpl));
    const n = Number(raw);
    return Number.isFinite(n) ? n : 0;
  }
  function setCycle(tpl, idx){
    storage.set(K.cycle(tpl), String(idx));
  }


  // Program sheet logic (touch devices)
  const programBtn = document.getElementById("programBtn");
  const programSheet = document.getElementById("programSheet");
  const programList = document.getElementById("programList");
  const programSearch = document.getElementById("programSearch");
  let programFilter = "";

  function openSheet(){
    if(!programSheet) return;
    programSheet.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
    setTimeout(()=>{ try{ programSearch && programSearch.focus(); }catch(e){} }, 40);
    renderProgramSheet();
  }
  function closeSheet(){
    if(!programSheet) return;
    programSheet.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
  }

  if(programBtn) programBtn.addEventListener("click", openSheet);
  if(programSheet){
    programSheet.addEventListener("click", (e)=>{
      const t = e.target;
      if(t && t.getAttribute && t.getAttribute("data-close")==="1") closeSheet();
    });
  }
  if(programSearch) programSearch.addEventListener("input", ()=>renderProgramSheet());
  document.querySelectorAll("[data-filter]").forEach(b=>{
    b.addEventListener("click", ()=>{
      programFilter = b.getAttribute("data-filter") || "";
      renderProgramSheet();
    });
  });

  function groupOrderKey(g){
    const s = (g||"").toLowerCase();
    if(s.includes("ног")) return 1;
    if(s.includes("груд") || s.includes("push")) return 2;
    if(s.includes("спин") || s.includes("pull")) return 3;
    if(s.includes("плеч")) return 4;
    if(s.includes("рук") || s.includes("arm")) return 5;
    if(s.includes("пресс") || s.includes("core")) return 6;
    if(s.includes("full")) return 7;
    return 99;
  }

  function renderProgramSheet(){
    if(!programList) return;
    const q = (programSearch?.value || "").trim().toLowerCase();

    const groups = Array.from(new Set(Object.values(PROGRAMS).map(p=>p.group || "Другое")))
      .sort((a,b)=> groupOrderKey(a)-groupOrderKey(b) || a.localeCompare(b));

    programList.innerHTML = "";
    groups.forEach(g=>{
      if(programFilter){
        const gg = (g||"").toLowerCase();
        const ff = (programFilter||"").toLowerCase();
        const ok = gg.includes(ff) || (ff==="грудь" && gg.includes("push")) || (ff==="спина" && gg.includes("pull"));
        if(!ok) return;
      }

      const keys = Object.keys(PROGRAMS)
        .filter(k => (PROGRAMS[k].group || "Другое") === g)
        .sort((a,b)=> (PROGRAMS[a].name||a).localeCompare(PROGRAMS[b].name||b))
        .filter(k=>{
          if(!q) return true;
          const p = PROGRAMS[k];
          return (p.name||"").toLowerCase().includes(q) || k.toLowerCase().includes(q) || (p.group||"").toLowerCase().includes(q);
        });

      if(keys.length===0) return;

      const block = document.createElement("div");
      block.className = "sheetGroup";
      block.innerHTML = `<div class="sheetGroupTitle">${g}</div>`;
      keys.forEach(k=>{
        const p = PROGRAMS[k];
        const row = document.createElement("div");
        row.className = "sheetItem";
        row.innerHTML = `<div class="sheetName">${p.name || k}</div><div class="sheetCode">${k.toUpperCase()}</div>`;
        row.addEventListener("click", ()=>{
          elProgram.value = k;
          // trigger existing update
          elProgram.dispatchEvent(new Event("change",{bubbles:true}));
          try{ if(programBtn) programBtn.textContent = p.name || k; }catch(e){}
          closeSheet();
        });
        block.appendChild(row);
      });
      programList.appendChild(block);
    });
  }



  // iPhone layout guard: find elements wider than viewport and auto-shrink them
  function fixOverflow(){
    try{
      const vw = document.documentElement.clientWidth;
      const els = Array.from(document.body.querySelectorAll("*"));
      for(const el of els){
        el.classList.remove("shrink");
      }
      // Skip hidden elements to reduce false positives
      for(const el of els){
        const cs = getComputedStyle(el);
        if(cs.display === "none" || cs.visibility === "hidden") continue;
        // Elements with fixed positioning can cause issues; still check width
        const r = el.getBoundingClientRect();
        // Check bounding box and scrollWidth
        if(r.width > vw + 1 || el.scrollWidth > vw + 2){
          el.classList.add("shrink");
        }
      }
    }catch(e){}
  }
  window.addEventListener("load", ()=>setTimeout(fixOverflow, 60));
  window.addEventListener("resize", ()=>setTimeout(fixOverflow, 60));

  // Init
  elDate.value = todayISO();
  renderAll();
</script>
  </div>
</body>
</html>
